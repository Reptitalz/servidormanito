/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model, validates data schemas, and provides scoped admin access.
 *
 * Data Structure & Validation:
 * - Each path has schema validation to enforce data types, formats, and required fields.
 * - Immutable fields like `userId` and `createdAt` are protected against modification after creation.
 * - Server timestamps are enforced for creation and update times.
 *
 * Key Security Decisions:
 * - User data is strictly owned and accessible only by the owner or an admin.
 * - Admins have read-only access to most user data for monitoring but limited write capabilities to prevent accidental modification.
 * - Public data access is explicitly denied unless specified (e.g., plans).
 * - Collection group queries are restricted to admins for system-wide monitoring.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // This email must match the admin user's email.
    function isAdmin() {
      return request.auth.token.email == "reptitalz@heymanito.com";
    }

    // --- User Profile Validation Functions ---
    function isValidUserProfile(data) {
      return data.displayName is string && data.displayName.size() > 0 &&
             data.email is string && data.email.matches('.+@.+\..+') &&
             data.photoURL is string &&
             data.createdAt is timestamp;
    }

    // --- Assistant Validation Functions ---
    function isValidAssistant(data, userId) {
        return data.name is string && data.name.size() > 2 &&
               data.personality is string &&
               data.skills is list &&
               data.status is string && (data.status == "Activo" || data.status == "Inactivo" || data.status == "Pausado") &&
               data.userId == userId &&
               data.createdAt is timestamp &&
               data.lastUpdate is timestamp;
    }

    // --- Client Validation Functions ---
     function isValidClient(data, userId) {
        return data.name is string && data.name.size() > 0 &&
               data.phone is string && data.phone.size() > 5 &&
               data.userId == userId;
    }


    // --- Path Rules ---

    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      
      allow create: if isOwner(userId) && isValidUserProfile(request.resource.data) &&
                       request.resource.data.createdAt == request.time;

      allow update: if isOwner(userId) &&
                       isValidUserProfile(request.resource.data) &&
                       request.resource.data.createdAt == resource.data.createdAt; // Cannot change creation date
      
      allow delete: if isOwner(userId);
    }

    match /plans/{planId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false; // Managed by backend only
    }

    match /users/{userId}/subscriptions/{subscriptionId} {
      allow get, list: if isOwner(userId) || isAdmin();
      
      // Allow create/update/delete only for owner with validation
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isOwner(userId);
    }

    match /users/{userId}/assistants/{assistantId} {
      allow get, list: if isOwner(userId) || isAdmin();

      allow create: if isOwner(userId) && 
                       isValidAssistant(request.resource.data, userId) &&
                       request.resource.data.createdAt == request.time &&
                       request.resource.data.lastUpdate == request.time;
                       
      allow update: if isOwner(userId) &&
                       isValidAssistant(request.resource.data, userId) &&
                       request.resource.data.userId == resource.data.userId &&       // Cannot change owner
                       request.resource.data.createdAt == resource.data.createdAt && // Cannot change creation date
                       request.resource.data.lastUpdate == request.time;             // Must be a server timestamp
                       
      allow delete: if isOwner(userId);
    }
    
    match /users/{userId}/clients/{clientId} {
      allow get, list: if isOwner(userId) || isAdmin();

      allow create: if isOwner(userId) && isValidClient(request.resource.data, userId);
      allow update: if isOwner(userId) && isValidClient(request.resource.data, userId) &&
                       request.resource.data.userId == resource.data.userId; // Cannot change owner
      allow delete: if isOwner(userId);
    }
    
    // Collection group query for assistants, only for admins.
    match /{path=**}/assistants/{assistantId} {
      allow get, list: if isAdmin();
    }
  }
}
